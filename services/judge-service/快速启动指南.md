# Judge Service 快速启动指南

## ✅ 已解决：禁用Redis和RabbitMQ

配置文件已更新，现在可以在**没有Redis和RabbitMQ**的情况下启动评测服务！

## 🚀 启动步骤

### 1. 确保必需组件运行中

```bash
# 检查MySQL
mysql -u cloud_oj -pcloud_oj_2025 -e "SELECT 1"

# 检查Nacos
# 访问：http://localhost:8848/nacos
```

### 2. 初始化数据库

```bash
# 在项目根目录的sql文件夹执行
cd d:\dev\pyfile\royuki-cloud-oj\sql

# 执行评测服务数据库初始化
mysql -u cloud_oj -pcloud_oj_2025 cloud_oj_judge < 4_judge_service.sql
```

### 3. 启动评测服务

**方式1：在IDEA中启动**
1. 找到 `JudgeServiceApplication.java`
2. 右键 → Run 'JudgeServiceApplication'

**方式2：命令行启动**
```bash
cd services/judge-service
mvn spring-boot:run
```

### 4. 验证启动成功

**查看控制台输出**：
```
========================================
评测服务启动成功！
服务端口: 8083
========================================
```

**访问健康检查接口**：
```bash
# 直接访问
curl http://localhost:8083/judge/health
# 预期返回：Judge Service is running!

# 通过网关访问
curl http://localhost:8080/api/judge/health
```

## 🎯 测试评测功能

### 提交一段代码

使用项目根目录的 `测试评测服务API.http` 文件：

```http
POST http://localhost:8083/judge/submit
Content-Type: application/json

{
  "problemId": 1,
  "userId": 3,
  "language": "JAVA",
  "code": "public class Solution {\n    public int[] twoSum(int[] nums, int target) {\n        return new int[0];\n    }\n}"
}
```

**预期响应**：
```json
{
  "code": 200,
  "message": "success",
  "data": 1  // submissionId
}
```

### 查询评测结果

```http
GET http://localhost:8083/judge/result/1
```

**预期响应**：
```json
{
  "code": 200,
  "data": {
    "submissionId": 1,
    "status": "ACCEPTED",
    "statusDesc": "通过",
    "score": 100,
    "timeUsed": 125,
    "memoryUsed": 8192,
    "passRate": "100.00%"
  }
}
```

## ❓ 常见问题

### Q1: 启动时报错找不到Redis连接？
**A**: 检查配置文件是否正确禁用了Redis：
```yaml
autoconfigure:
  exclude:
    - org.springframework.boot.autoconfigure.data.redis.RedisAutoConfiguration
```

### Q2: 启动时报错RabbitMQ连接失败？
**A**: 检查配置文件是否正确禁用了RabbitMQ：
```yaml
autoconfigure:
  exclude:
    - org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration
```

### Q3: 数据库连接失败？
**A**: 检查：
- MySQL是否运行：`mysql -u cloud_oj -pcloud_oj_2025`
- 数据库是否存在：`SHOW DATABASES LIKE 'cloud_oj_judge'`
- 用户权限是否正确

### Q4: Nacos注册失败？
**A**: 检查：
- Nacos是否运行：访问 http://localhost:8848/nacos
- 配置中的地址是否正确：`server-addr: 127.0.0.1:8848`

## 📊 当前服务状态

| 服务 | 端口 | 状态 | 访问地址 |
|------|------|------|---------|
| Gateway | 8080 | ✅ | http://localhost:8080 |
| User Service | 8081 | ✅ | http://localhost:8081 |
| Problem Service | 8082 | ✅ | http://localhost:8082 |
| **Judge Service** | **8083** | ✅ | http://localhost:8083 |

## 🎨 评测流程说明

### 当前简化流程（同步评测）

```
用户提交代码
    ↓
保存到数据库（状态：PENDING）
    ↓
立即执行模拟评测
    ↓
更新数据库（状态：ACCEPTED等）
    ↓
返回结果
```

### 未来完整流程（需要RabbitMQ）

```
用户提交代码
    ↓
保存到数据库（状态：PENDING）
    ↓
发送到RabbitMQ队列
    ↓
立即返回submissionId（快速响应）
    ↓
后台消费者从队列取任务
    ↓
Docker沙箱中编译运行
    ↓
对比测试用例
    ↓
更新数据库
    ↓
WebSocket推送结果
```

## 📚 下一步学习

### 阶段1：熟悉基本功能（当前）
- [x] 启动三个核心服务
- [ ] 测试代码提交
- [ ] 测试查询功能
- [ ] 理解评测流程

### 阶段2：添加Redis缓存
- [ ] 安装Redis（Windows/WSL/Docker）
- [ ] 启用Redis配置
- [ ] 实现题目缓存
- [ ] 实现Session共享

### 阶段3：实现异步评测
- [ ] 安装RabbitMQ
- [ ] 启用RabbitMQ配置
- [ ] 实现消息队列
- [ ] 实现异步消费者

### 阶段4：Docker沙箱
- [ ] 安装Docker
- [ ] 实现真实编译
- [ ] 资源限制
- [ ] 安全隔离

## 🔗 相关文档

- `中间件说明和安装指南.md` - Redis、RabbitMQ详细说明
- `README.md` - 完整的服务说明
- `测试评测服务API.http` - API测试用例

---

**启动成功后，你就有了一个完整的在线评测系统原型！** 🎉

虽然目前是模拟评测（随机生成结果），但整个系统架构、数据流程、API接口都已经搭建完成。

接下来可以：
1. 熟悉当前功能
2. 测试所有API
3. 理解代码结构
4. 逐步添加真实评测功能
