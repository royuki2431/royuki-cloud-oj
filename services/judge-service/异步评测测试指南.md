# å¼‚æ­¥è¯„æµ‹æµ‹è¯•æŒ‡å—

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. ç¡®è®¤ç¯å¢ƒå‡†å¤‡

```bash
# æ£€æŸ¥Dockerä¸­çš„Redis
docker ps | grep redis
# åº”è¯¥çœ‹åˆ°ï¼šrediså®¹å™¨è¿è¡Œä¸­ï¼Œç«¯å£6379

# æ£€æŸ¥Dockerä¸­çš„RabbitMQ
docker ps | grep rabbitmq
# åº”è¯¥çœ‹åˆ°ï¼šrabbitmqå®¹å™¨è¿è¡Œä¸­ï¼Œç«¯å£5672å’Œ15672

# æ£€æŸ¥MySQL
mysql -u cloud_oj -pcloud_oj_2025 -e "USE cloud_oj_judge; SHOW TABLES;"

# æ£€æŸ¥Nacos
# è®¿é—®ï¼šhttp://localhost:8848/nacos
```

### 2. å¯åŠ¨judge-service

```bash
# åœ¨IDEAä¸­å¯åŠ¨æˆ–ä½¿ç”¨å‘½ä»¤è¡Œ
cd services/judge-service
mvn spring-boot:run
```

**æˆåŠŸå¯åŠ¨çš„æ ‡å¿—**ï¼š
```
========================================
è¯„æµ‹æœåŠ¡å¯åŠ¨æˆåŠŸï¼
æœåŠ¡ç«¯å£: 8083
Redisè¿æ¥æˆåŠŸ
RabbitMQè¿æ¥æˆåŠŸ
========================================
```

---

## ğŸ§ª æµ‹è¯•å¼‚æ­¥è¯„æµ‹æµç¨‹

### æµ‹è¯•1ï¼šæäº¤ä»£ç ï¼ˆè§‚å¯Ÿå¼‚æ­¥æµç¨‹ï¼‰

**æ­¥éª¤1ï¼šæäº¤ä»£ç **
```http
POST http://localhost:8083/judge/submit
Content-Type: application/json

{
  "problemId": 1,
  "userId": 3,
  "language": "JAVA",
  "code": "public class Solution { ... }"
}
```

**é¢„æœŸå“åº”**ï¼ˆç«‹å³è¿”å›ï¼Œ<100msï¼‰ï¼š
```json
{
  "code": 200,
  "message": "success",
  "data": 123  // è¿™æ˜¯submissionId
}
```

**è§‚å¯Ÿåå°æ—¥å¿—**ï¼š
```
ä»£ç æäº¤æˆåŠŸ, submissionId=123, problemId=1, userId=3
è¯„æµ‹ä»»åŠ¡å·²å‘é€åˆ°é˜Ÿåˆ—, submissionId=123
========================================
æ”¶åˆ°è¯„æµ‹ä»»åŠ¡: submissionId=123, problemId=1, language=JAVA
å¼€å§‹è¯„æµ‹, submissionId=123, language=JAVA
è¯„æµ‹å®Œæˆ, submissionId=123, status=ACCEPTED, score=100
è¯„æµ‹ä»»åŠ¡å®Œæˆ: submissionId=123
========================================
```

---

**æ­¥éª¤2ï¼šç«‹å³æŸ¥è¯¢ç»“æœ**ï¼ˆå¯èƒ½è¿˜åœ¨è¯„æµ‹ä¸­ï¼‰
```http
GET http://localhost:8083/judge/result/123
```

**å¯èƒ½çš„å“åº”1**ï¼ˆè¯„æµ‹ä¸­ï¼‰ï¼š
```json
{
  "code": 200,
  "data": {
    "submissionId": 123,
    "status": "PENDING",
    "statusDesc": "ç­‰å¾…è¯„æµ‹"
  }
}
```

æˆ–

**å¯èƒ½çš„å“åº”2**ï¼ˆè¯„æµ‹ä¸­ï¼‰ï¼š
```json
{
  "code": 200,
  "data": {
    "submissionId": 123,
    "status": "JUDGING",
    "statusDesc": "è¯„æµ‹ä¸­"
  }
}
```

---

**æ­¥éª¤3ï¼šç­‰å¾…2ç§’åå†æ¬¡æŸ¥è¯¢**
```http
GET http://localhost:8083/judge/result/123
```

**é¢„æœŸå“åº”**ï¼ˆè¯„æµ‹å®Œæˆï¼‰ï¼š
```json
{
  "code": 200,
  "data": {
    "submissionId": 123,
    "status": "ACCEPTED",
    "statusDesc": "é€šè¿‡",
    "score": 100,
    "timeUsed": 125,
    "memoryUsed": 8192,
    "passRate": "100.00%"
  }
}
```

**è§‚å¯Ÿæ—¥å¿—**ï¼ˆç¬¬äºŒæ¬¡æŸ¥è¯¢ï¼‰ï¼š
```
ä»ç¼“å­˜è·å–è¯„æµ‹ç»“æœ, submissionId=123
```
âœ¨ **è¯´æ˜ç¼“å­˜ç”Ÿæ•ˆäº†ï¼**

---

### æµ‹è¯•2ï¼šéªŒè¯Redisç¼“å­˜

**æ¸…é™¤Redisç¼“å­˜**ï¼š
```bash
docker exec -it redis redis-cli
> DEL judge:result:123
> DEL submission:123
> exit
```

**ç¬¬ä¸€æ¬¡æŸ¥è¯¢**ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰ï¼š
```http
GET http://localhost:8083/judge/result/123
```

æ—¥å¿—ï¼š
```
ä»æ•°æ®åº“æŸ¥è¯¢è¯„æµ‹ç»“æœ
è¯„æµ‹ç»“æœå·²ç¼“å­˜, submissionId=123
```

**ç¬¬äºŒæ¬¡æŸ¥è¯¢**ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰ï¼š
```http
GET http://localhost:8083/judge/result/123
```

æ—¥å¿—ï¼š
```
ä»ç¼“å­˜è·å–è¯„æµ‹ç»“æœ, submissionId=123  âš¡ å¿«25å€ï¼
```

---

### æµ‹è¯•3ï¼šéªŒè¯RabbitMQé˜Ÿåˆ—

**è®¿é—®RabbitMQç®¡ç†ç•Œé¢**ï¼š
```
URL: http://localhost:15672
ç”¨æˆ·å: guest
å¯†ç : guest
```

**æ“ä½œæ­¥éª¤**ï¼š
1. ç‚¹å‡»"Queues"æ ‡ç­¾
2. æ‰¾åˆ°`judge.queue`
3. è§‚å¯Ÿé˜Ÿåˆ—çŠ¶æ€ï¼š
   - Ready: å¾…å¤„ç†æ¶ˆæ¯æ•°
   - Unacked: æ­£åœ¨å¤„ç†çš„æ¶ˆæ¯æ•°
   - Total: æ€»æ¶ˆæ¯æ•°

**æäº¤å¤šä¸ªä»»åŠ¡è§‚å¯Ÿé˜Ÿåˆ—**ï¼š
```bash
# å¿«é€Ÿæäº¤10ä¸ªä»»åŠ¡
for i in {1..10}; do
  curl -X POST http://localhost:8083/judge/submit \
    -H "Content-Type: application/json" \
    -d '{"problemId":1,"userId":3,"language":"JAVA","code":"..."}' &
done
```
åœ¨Â·
åœ¨RabbitMQç•Œé¢è§‚å¯Ÿï¼š
- æ¶ˆæ¯å¿«é€Ÿè¿›å…¥é˜Ÿåˆ—
- 5ä¸ªæ¶ˆè´¹è€…å¹¶å‘å¤„ç†
- æ¶ˆæ¯é€æ¸è¢«æ¶ˆè´¹å®Œæ¯•

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”æµ‹è¯•

### æµ‹è¯•å·¥å…·ï¼šApache Bench (ab)

**å®‰è£…ab**ï¼ˆå¦‚æœæ²¡æœ‰ï¼‰ï¼š
```bash
# Windows
choco install apache-httpd

# æˆ–ä½¿ç”¨WSL
sudo apt-get install apache2-utils
```

### æµ‹è¯•1ï¼šæäº¤æ¥å£æ€§èƒ½

**æµ‹è¯•å‘½ä»¤**ï¼š
```bash
ab -n 100 -c 10 -p submit.json -T application/json \
  http://localhost:8083/judge/submit
```

å…¶ä¸­`submit.json`å†…å®¹ï¼š
```json
{
  "problemId": 1,
  "userId": 3,
  "language": "JAVA",
  "code": "public class Solution { }"
}
```

**é¢„æœŸç»“æœ**ï¼š
```
Requests per second:    200 [#/sec]   # æ¯ç§’200ä¸ªè¯·æ±‚
Time per request:       50 [ms]       # å¹³å‡50ms
Time per request:       5 [ms] (mean) # å¹¶å‘ä¸‹5ms
```

### æµ‹è¯•2ï¼šæŸ¥è¯¢æ¥å£æ€§èƒ½ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰

```bash
ab -n 1000 -c 50 http://localhost:8083/judge/result/123
```

**é¢„æœŸç»“æœ**ï¼ˆç¼“å­˜å‘½ä¸­ï¼‰ï¼š
```
Requests per second:    5000 [#/sec]  # æ¯ç§’5000ä¸ªè¯·æ±‚
Time per request:       10 [ms]       # å¹³å‡10ms
Time per request:       0.2 [ms]      # å¹¶å‘ä¸‹0.2ms âš¡
```

### æµ‹è¯•3ï¼šæŸ¥è¯¢æ¥å£æ€§èƒ½ï¼ˆç¼“å­˜æœªå‘½ä¸­ï¼‰

å…ˆæ¸…é™¤ç¼“å­˜ï¼Œç„¶åæµ‹è¯•ï¼š
```bash
docker exec -it redis redis-cli FLUSHDB
ab -n 100 -c 10 http://localhost:8083/judge/result/123
```

**é¢„æœŸç»“æœ**ï¼ˆæ•°æ®åº“æŸ¥è¯¢ï¼‰ï¼š
```
Requests per second:    200 [#/sec]   # æ¯ç§’200ä¸ªè¯·æ±‚
Time per request:       50 [ms]       # å¹³å‡50ms
```

**å¯¹æ¯”**ï¼š
- ç¼“å­˜å‘½ä¸­ï¼š0.2ms âš¡
- ç¼“å­˜æœªå‘½ä¸­ï¼š50ms
- **æ€§èƒ½æå‡ï¼š250å€ï¼**

---

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### 1. æŸ¥çœ‹RabbitMQé˜Ÿåˆ—çŠ¶æ€

```bash
# æŸ¥çœ‹æ‰€æœ‰é˜Ÿåˆ—
docker exec -it rabbitmq rabbitmqctl list_queues

# è¾“å‡ºï¼š
# judge.queue  5               # 5æ¡å¾…å¤„ç†
# judge.dead.letter.queue  0   # 0æ¡å¤±è´¥
```

### 2. æŸ¥çœ‹Redisç¼“å­˜

```bash
# è¿æ¥Redis
docker exec -it redis redis-cli

# æŸ¥çœ‹æ‰€æœ‰ç¼“å­˜key
> KEYS *
1) "submission:123"
2) "judge:result:123"
3) "submission:124"

# æŸ¥çœ‹æŸä¸ªkeyçš„å€¼
> GET "judge:result:123"
"{\"submissionId\":123,\"status\":\"ACCEPTED\"...}"

# æŸ¥çœ‹è¿‡æœŸæ—¶é—´ï¼ˆç§’ï¼‰
> TTL "judge:result:123"
(integer) 298  # è¿˜æœ‰298ç§’è¿‡æœŸ

# æŸ¥çœ‹ç¼“å­˜ç»Ÿè®¡
> INFO stats
# keyspace_hits: ç¼“å­˜å‘½ä¸­æ¬¡æ•°
# keyspace_misses: ç¼“å­˜æœªå‘½ä¸­æ¬¡æ•°
```

**è®¡ç®—ç¼“å­˜å‘½ä¸­ç‡**ï¼š
```
å‘½ä¸­ç‡ = hits / (hits + misses) * 100%
```

### 3. ç›‘æ§è¯„æµ‹æ¶ˆè´¹é€Ÿåº¦

```bash
# è§‚å¯Ÿæ—¥å¿—ä¸­çš„è¯„æµ‹ä»»åŠ¡
tail -f logs/judge-service.log | grep "è¯„æµ‹ä»»åŠ¡å®Œæˆ"

# è¾“å‡ºï¼š
# è¯„æµ‹ä»»åŠ¡å®Œæˆ: submissionId=123
# è¯„æµ‹ä»»åŠ¡å®Œæˆ: submissionId=124
# è¯„æµ‹ä»»åŠ¡å®Œæˆ: submissionId=125
```

ç»Ÿè®¡æ¯ç§’å¤„ç†æ•°ï¼š
```bash
tail -f logs/judge-service.log | grep "è¯„æµ‹ä»»åŠ¡å®Œæˆ" | while read line; do
  echo "$(date '+%H:%M:%S') - $line"
done
```

---

## ğŸ› é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šæäº¤åæŸ¥è¯¢ä¸€ç›´æ˜¯PENDING

**å¯èƒ½åŸå› **ï¼š
1. æ¶ˆè´¹è€…æœªå¯åŠ¨
2. æ¶ˆæ¯æœªå‘é€åˆ°é˜Ÿåˆ—
3. æ¶ˆè´¹è€…å¤„ç†å¤±è´¥

**æ’æŸ¥æ­¥éª¤**ï¼š

**1. æ£€æŸ¥æ¶ˆè´¹è€…æ˜¯å¦å¯åŠ¨**
```bash
# æŸ¥çœ‹æ—¥å¿—æ˜¯å¦æœ‰æ¶ˆè´¹è€…å¯åŠ¨ä¿¡æ¯
tail -f logs/judge-service.log | grep "SimpleMessageListenerContainer"
```

**2. æ£€æŸ¥é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰æ¶ˆæ¯**
è®¿é—® http://localhost:15672ï¼ŒæŸ¥çœ‹`judge.queue`çš„æ¶ˆæ¯æ•°

**3. æ£€æŸ¥æ­»ä¿¡é˜Ÿåˆ—**
æŸ¥çœ‹`judge.dead.letter.queue`æ˜¯å¦æœ‰æ¶ˆæ¯ï¼ˆè¯´æ˜æ¶ˆè´¹å¤±è´¥ï¼‰

**4. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**
```bash
tail -f logs/judge-service.log | grep -E "(æ”¶åˆ°è¯„æµ‹ä»»åŠ¡|è¯„æµ‹å¤±è´¥)"
```

---

### é—®é¢˜2ï¼šç¼“å­˜ä¸ç”Ÿæ•ˆ

**ç—‡çŠ¶**ï¼šæ¯æ¬¡æŸ¥è¯¢éƒ½æ˜¾ç¤º"ä»æ•°æ®åº“æŸ¥è¯¢"

**æ’æŸ¥æ­¥éª¤**ï¼š

**1. æ£€æŸ¥Redisè¿æ¥**
```bash
docker exec -it redis redis-cli PING
# åº”è¿”å›: PONG
```

**2. æ£€æŸ¥åº”ç”¨æ—¥å¿—**
```bash
tail -f logs/judge-service.log | grep Redis
# åº”è¯¥çœ‹åˆ°è¿æ¥æˆåŠŸä¿¡æ¯
```

**3. æ‰‹åŠ¨æµ‹è¯•Redis**
```bash
docker exec -it redis redis-cli
> SET test "hello"
> GET test
# åº”è¿”å›: "hello"
```

**4. æ£€æŸ¥åºåˆ—åŒ–é—®é¢˜**
```bash
# æŸ¥çœ‹æ—¥å¿—ä¸­æ˜¯å¦æœ‰åºåˆ—åŒ–å¼‚å¸¸
tail -f logs/judge-service.log | grep -i "serializ"
```

---

### é—®é¢˜3ï¼šæ¶ˆæ¯å¤„ç†å¤±è´¥è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—

**ç—‡çŠ¶**ï¼šæ­»ä¿¡é˜Ÿåˆ—æœ‰æ¶ˆæ¯

**æ’æŸ¥æ­¥éª¤**ï¼š

**1. æŸ¥çœ‹æ­»ä¿¡æ¶ˆæ¯å†…å®¹**
åœ¨RabbitMQç®¡ç†ç•Œé¢ï¼š
- è¿›å…¥`judge.dead.letter.queue`
- ç‚¹å‡»"Get messages"
- æŸ¥çœ‹æ¶ˆæ¯å†…å®¹å’Œé”™è¯¯ä¿¡æ¯

**2. æŸ¥çœ‹æ—¥å¿—ä¸­çš„é”™è¯¯**
```bash
tail -f logs/judge-service.log | grep "æ­»ä¿¡æ¶ˆæ¯"
```

**3. é‡æ–°å¤„ç†æ­»ä¿¡æ¶ˆæ¯**
```bash
# å¦‚æœç¡®è®¤é—®é¢˜å·²ä¿®å¤ï¼Œå¯ä»¥å°†æ­»ä¿¡æ¶ˆæ¯ç§»å›åŸé˜Ÿåˆ—
# ï¼ˆéœ€è¦é€šè¿‡RabbitMQ APIæˆ–ç®¡ç†ç•Œé¢æ“ä½œï¼‰
```

---

## ğŸ“ˆ å‹åŠ›æµ‹è¯•

### æµ‹è¯•åœºæ™¯ï¼š100å¹¶å‘æäº¤

**ç›®æ ‡**ï¼šéªŒè¯å¼‚æ­¥é˜Ÿåˆ—çš„å‰Šå³°èƒ½åŠ›

**æµ‹è¯•è„šæœ¬**ï¼š
```bash
#!/bin/bash
# stress_test.sh

for i in {1..100}; do
  curl -s -X POST http://localhost:8083/judge/submit \
    -H "Content-Type: application/json" \
    -d "{\"problemId\":1,\"userId\":$i,\"language\":\"JAVA\",\"code\":\"test\"}" &
done

wait
echo "100ä¸ªä»»åŠ¡å·²æäº¤"
```

**æ‰§è¡Œæµ‹è¯•**ï¼š
```bash
chmod +x stress_test.sh
time ./stress_test.sh
```

**è§‚å¯ŸæŒ‡æ ‡**ï¼š
1. **æäº¤è€—æ—¶**ï¼šåº”è¯¥åœ¨5ç§’å†…å®Œæˆ
2. **é˜Ÿåˆ—çŠ¶æ€**ï¼šRabbitMQé˜Ÿåˆ—ä¼šè¿…é€Ÿå¢åŠ åˆ°100
3. **æ¶ˆè´¹é€Ÿåº¦**ï¼š5ä¸ªæ¶ˆè´¹è€…å¹¶å‘å¤„ç†ï¼Œçº¦20ç§’å¤„ç†å®Œ
4. **ç³»ç»Ÿè´Ÿè½½**ï¼šCPUå’Œå†…å­˜åº”ä¿æŒç¨³å®š

**é¢„æœŸç»“æœ**ï¼š
```
100ä¸ªä»»åŠ¡å·²æäº¤

real    0m3.5s   # æäº¤æ€»è€—æ—¶3.5ç§’
user    0m0.5s
sys     0m0.8s
```

---

## âœ… æµ‹è¯•æ£€æŸ¥æ¸…å•

### åŸºç¡€åŠŸèƒ½
- [ ] æäº¤ä»£ç æˆåŠŸè¿”å›submissionId
- [ ] æäº¤åç«‹å³è¿”å›ï¼ˆ<100msï¼‰
- [ ] åå°æ¶ˆè´¹è€…æˆåŠŸå¤„ç†è¯„æµ‹ä»»åŠ¡
- [ ] æŸ¥è¯¢ç»“æœæ­£ç¡®

### å¼‚æ­¥æµç¨‹
- [ ] æäº¤åç«‹å³æŸ¥è¯¢å¯èƒ½è¿”å›PENDING
- [ ] ç­‰å¾…åæŸ¥è¯¢è¿”å›æœ€ç»ˆç»“æœ
- [ ] RabbitMQé˜Ÿåˆ—æ­£å¸¸å·¥ä½œ
- [ ] æ¶ˆè´¹è€…å¹¶å‘å¤„ç†ä»»åŠ¡

### ç¼“å­˜åŠŸèƒ½
- [ ] ç¬¬ä¸€æ¬¡æŸ¥è¯¢ä»æ•°æ®åº“è·å–
- [ ] ç¬¬äºŒæ¬¡æŸ¥è¯¢ä»ç¼“å­˜è·å–
- [ ] è¯„æµ‹å®Œæˆåç¼“å­˜è¢«æ¸…é™¤
- [ ] ç¼“å­˜è¿‡æœŸåè‡ªåŠ¨å¤±æ•ˆï¼ˆ5åˆ†é’Ÿï¼‰

### å¤±è´¥å¤„ç†
- [ ] è¯„æµ‹å¤±è´¥è‡ªåŠ¨é‡è¯•ï¼ˆæœ€å¤š3æ¬¡ï¼‰
- [ ] è¶…è¿‡é‡è¯•æ¬¡æ•°è¿›å…¥æ­»ä¿¡é˜Ÿåˆ—
- [ ] æ­»ä¿¡é˜Ÿåˆ—æ¶ˆæ¯è¢«æ­£ç¡®å¤„ç†

### æ€§èƒ½æŒ‡æ ‡
- [ ] æäº¤æ¥å£å“åº”æ—¶é—´ < 100ms
- [ ] ç¼“å­˜å‘½ä¸­æŸ¥è¯¢å“åº”æ—¶é—´ < 10ms
- [ ] 100å¹¶å‘æäº¤ä¸é˜»å¡
- [ ] ç³»ç»Ÿèµ„æºå ç”¨æ­£å¸¸

---

## ğŸ¯ æˆåŠŸæ ‡å‡†

å¦‚æœä»¥ä¸Šæµ‹è¯•éƒ½é€šè¿‡ï¼Œè¯´æ˜ï¼š

1. âœ… **å¼‚æ­¥è¯„æµ‹**å·¥ä½œæ­£å¸¸
   - æäº¤å¿«é€Ÿå“åº”
   - åå°æ¶ˆè´¹è€…æ­£å¸¸å·¥ä½œ
   - é˜Ÿåˆ—å‰Šå³°å¡«è°·æ•ˆæœè‰¯å¥½

2. âœ… **Redisç¼“å­˜**å·¥ä½œæ­£å¸¸
   - ç¼“å­˜å‘½ä¸­ç‡é«˜
   - æŸ¥è¯¢æ€§èƒ½æå‡æ˜¾è‘—
   - ç¼“å­˜å¤±æ•ˆæœºåˆ¶æ­£ç¡®

3. âœ… **é«˜å¯ç”¨æ€§**
   - å¤±è´¥è‡ªåŠ¨é‡è¯•
   - æ­»ä¿¡é˜Ÿåˆ—ä¿åº•
   - ç³»ç»Ÿç¨³å®šå¯é 

**æ­å–œï¼ä½ çš„è¯„æµ‹ç³»ç»Ÿå·²ç»è¾¾åˆ°ç”Ÿäº§çº§åˆ«ï¼** ğŸ‰

---

## ğŸ“š ä¸‹ä¸€æ­¥

å®Œæˆæµ‹è¯•åï¼Œå¯ä»¥ï¼š
1. é˜…è¯»ã€Šå¼‚æ­¥è¯„æµ‹å’Œç¼“å­˜ä½¿ç”¨æŒ‡å—.mdã€‹äº†è§£å®ç°ç»†èŠ‚
2. æŸ¥çœ‹RabbitMQå’ŒRedisç›‘æ§æ•°æ®
3. å°è¯•è°ƒæ•´æ¶ˆè´¹è€…å¹¶å‘æ•°ä¼˜åŒ–æ€§èƒ½
4. å¼€å§‹å®ç°çœŸå®çš„Dockeræ²™ç®±è¯„æµ‹
